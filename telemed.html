<!DOCTYPE html>
<html>
<head>
  <title>SAH Video Call</title>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #info-box {
      position: absolute; top: 10px; left: 10px;
      background: #fff; padding: 10px; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 10;
    }
    #video-wrapper {
      display: flex; flex-wrap: wrap;
      justify-content: center; align-items: center;
      height: 100vh; padding-top: 80px;
      background: #f0f0f0;
    }
    #local-player, #remote-player {
      width: 45%; min-width: 300px; height: 240px;
      background: #ccc; margin: 10px; border-radius: 8px;
    }
    #controls {
      text-align: center; margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="info-box">
    <strong>Channel:</strong> <span id="channel-display"></span><br>
    <strong>User:</strong> <span id="uid-display"></span>
  </div>

  <div id="video-wrapper">
    <div id="local-player"></div>
    <div id="remote-player"></div>
  </div>

  <div id="controls">
    <button onclick="toggleMic()" id="mic-btn">Mute Mic</button>
    <button onclick="toggleCam()" id="cam-btn">Turn Off Camera</button>
  </div>

  <script>
    const appId = "9215eef13c1f4b8b88b20e217e027462";
    const urlParams = new URLSearchParams(window.location.search);
    const channel = urlParams.get("channel") || "sah_default";
    const uid = urlParams.get("user") || Math.floor(Math.random() * 100000);

    document.getElementById("channel-display").textContent = channel;
    document.getElementById("uid-display").textContent = uid;

    const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    let localTracks = { videoTrack: null, audioTrack: null };

    async function startCall() {
      await client.join(appId, channel, null, uid);
      [localTracks.audioTrack, localTracks.videoTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();

      localTracks.videoTrack.play("local-player");
      await client.publish(Object.values(localTracks));

      client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);
        if (mediaType === "video") {
          user.videoTrack.play("remote-player");
        }
        if (mediaType === "audio") {
          user.audioTrack.play();
        }
      });

      client.on("user-unpublished", user => {
        document.getElementById("remote-player").innerHTML = "";
      });
    }

    function toggleMic() {
      const btn = document.getElementById("mic-btn");
      const enabled = localTracks.audioTrack.isEnabled;
      localTracks.audioTrack.setEnabled(!enabled);
      btn.innerText = enabled ? "Unmute Mic" : "Mute Mic";
    }

    function toggleCam() {
      const btn = document.getElementById("cam-btn");
      const enabled = localTracks.videoTrack.isEnabled;
      localTracks.videoTrack.setEnabled(!enabled);
      btn.innerText = enabled ? "Turn On Camera" : "Turn Off Camera";
    }

    window.addEventListener("beforeunload", async () => {
      if (localTracks.videoTrack) localTracks.videoTrack.stop();
      if (localTracks.audioTrack) localTracks.audioTrack.stop();
      await client.leave();
    });

    startCall();
  </script>
</body>
</html>
