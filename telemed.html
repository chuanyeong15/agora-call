<!DOCTYPE html>
<html>
<head>
  <title>SAH Video Call</title>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #video-container {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      background: #f0f0f0;
      position: relative;
    }

    .video-box {
      width: 45%;
      background: black;
      margin: 1%;
      border-radius: 8px;
      overflow: hidden;
      min-height: 240px;
    }

    #controls {
      padding: 10px;
      text-align: center;
      background: #eee;
    }

    #waiting-message {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      display: none;
      font-size: 14px;
    }

    button {
      padding: 8px 14px;
      margin: 0 8px;
      border: none;
      border-radius: 4px;
      background: #5c6bc0;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background: #3949ab;
    }
  </style>
</head>
<body>
  <div id="video-container">
    <div id="waiting-message">Waiting for other participant to join...</div>
    <div id="local-stream" class="video-box"></div>
    <div id="remote-streams" class="video-box"></div>
  </div>

  <div id="controls">
    <button id="toggle-mic">Mute Mic</button>
    <button id="toggle-cam">Turn Off Camera</button>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const appId = '9215eef13c1f4b8b88b20e217e027462';
    const channel = urlParams.get('channel') || 'test';
    const uid = urlParams.get('user') || null;

    const client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
    let micTrack, camTrack;
    let isCamOn = true;
    let isMicOn = true;

    async function startCall() {
      await client.join(appId, channel, null, uid);

      [micTrack, camTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();

      const localContainer = document.getElementById('local-stream');
      localContainer.id = uid || 'local-user';
      camTrack.play(localContainer);

      await client.publish([micTrack, camTrack]);

      document.getElementById('waiting-message').style.display = 'block';

      client.on('user-published', async (user, mediaType) => {
        await client.subscribe(user, mediaType);

        let remoteContainer = document.getElementById(`user-${user.uid}`);
        if (!remoteContainer) {
          remoteContainer = document.createElement('div');
          remoteContainer.id = `user-${user.uid}`;
          remoteContainer.className = 'video-box';
          document.getElementById('remote-streams').appendChild(remoteContainer);
        }

        if (mediaType === 'video') {
          user.videoTrack.play(remoteContainer);
        }
        if (mediaType === 'audio') {
          user.audioTrack.play();
        }

        document.getElementById('waiting-message').style.display = 'none';
      });

      client.on('user-unpublished', (user) => {
        const remote = document.getElementById(`user-${user.uid}`);
        if (remote) remote.remove();
        document.getElementById('waiting-message').style.display = 'block';
      });
    }

    document.getElementById('toggle-mic').addEventListener('click', () => {
      if (isMicOn) {
        micTrack.setEnabled(false);
        isMicOn = false;
        document.getElementById('toggle-mic').textContent = 'Unmute Mic';
      } else {
        micTrack.setEnabled(true);
        isMicOn = true;
        document.getElementById('toggle-mic').textContent = 'Mute Mic';
      }
    });

    document.getElementById('toggle-cam').addEventListener('click', () => {
      const container = document.getElementById('local-stream');
      if (isCamOn) {
        camTrack.setEnabled(false);
        isCamOn = false;
        container.innerHTML = ''; // clear video
        document.getElementById('toggle-cam').textContent = 'Turn On Camera';
      } else {
        camTrack.setEnabled(true);
        camTrack.play(container); // rebind to container
        isCamOn = true;
        document.getElementById('toggle-cam').textContent = 'Turn Off Camera';
      }
    });

    startCall();
  </script>
</body>
</html>
